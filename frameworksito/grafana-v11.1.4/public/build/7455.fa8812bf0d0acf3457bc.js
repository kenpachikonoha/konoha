"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[7455],{776:(pe,ne,e)=>{e.d(ne,{B:()=>c});var n=e(96540),t=e(42418),N=e(31678),ae=e(82843),L=e(23770),x=e(21607),U=e(57220),O=e(72399),I=e(49785),z=e(88575),w=e(10880);const J=({pathPrefix:m,className:F,readOnly:d=!1})=>{const{register:W}=(0,I.xW)();return n.createElement("div",{className:F},n.createElement(z.D,{disabled:d},n.createElement(w.S,{...W(`${m}sendResolved`),label:"Send resolved",disabled:d,description:"Whether or not to notify about resolved alerts."})))};var se=e(18022);const X=Object.freeze({__id:"",sendResolved:!0,secureSettings:{},settings:{},secureFields:{},type:"email"}),oe=x.r.map(m=>({dto:m})),c=({existing:m,alertManagerSourceName:F,config:d,readOnly:W=!1})=>{const P=(0,N.useDispatch)(),V=(0,U.AL)(F),[K]=(0,n.useMemo)(()=>m?(0,O.Iq)(m,x.r):[void 0,{}],[m]),Z=async A=>{const G=(0,O.QX)(A,X);await P((0,L.RW)({newConfig:(0,O.jS)(d,G,m?.name),oldConfig:d,alertManagerSourceName:F,successMessage:m?"Contact point updated.":"Contact point created.",redirectPath:"/alerting/notifications"})).then(()=>{P(ae.m.util.invalidateTags(["AlertmanagerConfiguration"]))})},k=(0,n.useMemo)(()=>d.alertmanager_config.receivers?.map(({name:A})=>A).filter(A=>A!==m?.name)??[],[d,m]),Y=!W;return n.createElement(n.Fragment,null,!V&&n.createElement(t.F,{title:"Info",severity:"info"},"Note that empty string values will be replaced with global defaults where appropriate."),n.createElement(se.k,{isEditable:Y,isTestable:Y,config:d,onSubmit:Z,initialValues:K,notifiers:oe,alertManagerSourceName:F,defaultItem:X,takenReceiverNames:k,commonSettingsComponent:J}))}},17430:(pe,ne,e)=>{e.d(ne,{a:()=>ge});var n=e(96540),t=e(39558),N=e(42418),ae=e(31678),L=e(82843),x=e(23770),U=e(57220),O=e(72399),I=e(48205),z=e(37534),w=e(59647),J=e(49785),se=e(88575),X=e(10880);const oe=({pathPrefix:l,className:a,readOnly:s=!1})=>{const{register:o}=(0,J.xW)();return n.createElement("div",{className:a},n.createElement(se.D,null,n.createElement(X.S,{...o(`${l}disableResolveMessage`),label:"Disable resolved message",description:"Disable the resolve message [OK] that is sent when alerting state returns to false",disabled:s})))};var c=e(18022),m=e(32196),F=e(40845),d=e(37390),W=e(60029),P=e(94354),V=e(55852),K=e(55740),Z=e(31099),k=e(97171),Y=(l=>(l.predefined="Predefined",l.custom="Custom",l))(Y||{});const A=Object.values(Y).map(l=>({label:l,value:l})),G={annotations:[...K.kl],labels:[{key:"",value:""}]},me=({isOpen:l,onDismiss:a,onTest:s})=>{const[o,p]=(0,n.useState)("Predefined"),E=(0,F.of)(ue),r=(0,J.mN)({defaultValues:G,mode:"onBlur"}),v=S=>{if(o==="Custom"){const j={annotations:S.annotations.filter(({key:u,value:i})=>!!u&&!!i).reduce((u,{key:i,value:D})=>({...u,[i]:D}),{}),labels:S.labels.filter(({key:u,value:i})=>!!u&&!!i).reduce((u,{key:i,value:D})=>({...u,[i]:D}),{})};s(j)}else s()};return n.createElement(d.a,{onDismiss:a,isOpen:l,title:"Test contact point"},n.createElement("div",{className:E.section},n.createElement(W.J,null,"Notification message"),n.createElement(P.z,{options:A,value:o,onChange:S=>p(S)})),n.createElement(J.Op,{...r},n.createElement("form",{onSubmit:r.handleSubmit(v)},o==="Predefined"&&n.createElement("div",{className:E.section},"You will send a test notification that uses a predefined alert. If you have defined a custom template or message, for better results switch to ",n.createElement("strong",null,"custom")," notification message, from above."),o==="Custom"&&n.createElement(n.Fragment,null,n.createElement("div",{className:E.section},"You will send a test notification that uses the annotations defined below. This is a good option if you use custom templates and messages."),n.createElement("div",{className:E.section},n.createElement(Z.A,null)),n.createElement("div",{className:E.section},n.createElement(k.Ay,null))),n.createElement(d.a.ButtonRow,null,n.createElement(V.$n,{type:"submit"},"Send test notification")))))},ue=l=>({flexRow:(0,m.css)({display:"flex",flexDirection:"row",alignItems:"flex-start",marginBottom:l.spacing(1)}),section:(0,m.css)({marginBottom:l.spacing(2)})}),ie=Object.freeze({__id:"",secureSettings:{},settings:{},secureFields:{},disableResolveMessage:!1,type:"email"}),ge=({existing:l,alertManagerSourceName:a,config:s,readOnly:o=!1})=>{const p=(0,ae.useDispatch)(),{onCallNotifierMeta:E,extendOnCallNotifierFeatures:r,extendOnCallReceivers:v,onCallFormValidators:S,createOnCallIntegrations:j,isLoadingOnCallIntegration:u,hasOnCallError:i}=(0,w.VY)(),{useGrafanaNotifiersQuery:D}=L.m,{data:M=[],isLoading:b}=D(),[h,q]=(0,n.useState)(),[R,_]=(0,n.useMemo)(()=>!l||b||u?[void 0,{}]:(0,O.Xo)(v(l),M),[l,b,M,v,u]),fe=async g=>{const te=(0,O.bB)(g,_,ie,M),y=await j(te),f=(0,O.jS)(s,y,l?.name);await p((0,x.RW)({newConfig:f,oldConfig:s,alertManagerSourceName:U.hY,successMessage:l?"Contact point updated.":"Contact point created",redirectPath:"/alerting/notifications"})).then(()=>{p(L.m.util.invalidateTags(["AlertmanagerConfiguration"]))})},ee=g=>{q(g)},Q=g=>{if(h){const te=_[h.__id],y=(0,O.qg)(h,ie,"test",te),f={alertManagerSourceName:a,receivers:[{name:"test",grafana_managed_receiver_configs:[y]}],alert:g};p((0,x.bO)(f))}},re=(0,n.useMemo)(()=>s.alertmanager_config.receivers?.map(({name:g})=>g).filter(g=>g!==l?.name)??[],[s,l]),le=l?(l.grafana_managed_receiver_configs??[]).some(g=>!!g.provenance):!1,ve=!o&&!le,Ce=!o;if(b||u)return n.createElement(t._,{text:"Loading notifiers..."});const ce=M.map(g=>g.type==="oncall"?{dto:r(g),meta:E}:{dto:g});return n.createElement(n.Fragment,null,i&&n.createElement(N.F,{severity:"error",title:"Loading OnCall integration failed"},"Grafana OnCall plugin has been enabled in your Grafana instances but it is not reachable. Please check the plugin configuration"),le&&n.createElement(I.Yi,{resource:I.hk.ContactPoint}),n.createElement(c.k,{isEditable:ve,isTestable:Ce,config:s,onSubmit:fe,initialValues:R,onTestChannel:ee,notifiers:ce,alertManagerSourceName:a,defaultItem:{...ie},takenReceiverNames:re,commonSettingsComponent:oe,customValidators:{[z.J4.OnCall]:S}}),n.createElement(me,{onDismiss:()=>q(void 0),isOpen:!!h,onTest:g=>Q(g)}))}},18022:(pe,ne,e)=>{e.d(ne,{k:()=>ie});var n=e(32196),t=e(96540),N=e(49785),ae=e(17172),L=e(40845),x=e(42418),U=e(88575),O=e(10354),I=e(55852),z=e(3169),w=e(40715),J=e(94954),se=e(25027),X=e(26423),oe=e(45124),c=e(56361),m=e(88467),F=e(2543),d=e(21594),W=e(61410),P=e(59647),V=e(23807);function K({defaultValues:a,selectedChannelOptions:s,onResetSecureField:o,secureFields:p,errors:E,pathPrefix:r="",readOnly:v=!1,customValidators:S={}}){const{watch:j}=(0,N.xW)(),u=j();return t.createElement(t.Fragment,null,s.map((i,D)=>{const M=`${i.label}-${D}`,b=r.split("."),h=b.length>=2?u.items?.[Number(b[1])].settings?.[i.showWhen.field]:void 0;if(i.showWhen.field&&h!==i.showWhen.is)return null;if(p&&p[i.propertyName])return t.createElement(U.D,{key:M,label:i.label,description:i.description||void 0},t.createElement(O.p,{readOnly:!0,value:"Configured",suffix:v?null:t.createElement(I.$n,{onClick:()=>o(i.propertyName),fill:"text",type:"button",size:"sm"},"Clear")}));const q=(i.secure?E?.secureSettings:E?.settings)?.[i.propertyName],R=a?.settings?.[i.propertyName];return t.createElement(V.e,{defaultValue:R,readOnly:v,key:M,error:q,pathPrefix:r,pathSuffix:i.secure?"secureSettings.":"settings.",option:i,customValidator:S[i.propertyName]})}))}var Z=e(14591);function k({defaultValues:a,initialValues:s,pathPrefix:o,onDuplicate:p,onDelete:E,onTest:r,notifiers:v,errors:S,secureFields:j,commonSettingsComponent:u,isEditable:i=!0,isTestable:D,customValidators:M={}}){const b=(0,L.of)(Y),h=(0,t.useCallback)(C=>`${o}${C}`,[o]),{control:q,watch:R,register:_,trigger:fe,formState:ee,setValue:Q}=(0,N.xW)(),re=R(h("type"))??a.type,{loading:le}=(0,W.$)(C=>C.testReceivers),Ce=R(h("settings.integration_type"))!==P.U0.NewIntegration;(0,t.useEffect)(()=>{_(`${o}.__id`),_(`${o}.secureFields`)},[_,o]),(0,t.useEffect)(()=>{const C=R(($,{name:B,type:Ee})=>{const he=B?$[B]:"";s&&B===h("type")&&he===s.type&&Ee==="change"&&Q(h("settings"),s.settings),s&&B===h("settings.integration_type")&&he===P.U0.ExistingIntegration&&Q(h("settings.url"),s.settings.url)});return()=>C.unsubscribe()},[re,s,Q,h,R]);const[ce,g]=(0,t.useState)(j??{}),te=C=>{if(ce[C]){const $={...j};delete $[C],g($),Q(`${o}.secureFields`,$)}},y=(0,t.useMemo)(()=>(0,F.sortBy)(v,({dto:C,meta:$})=>[$?.order??0,C.name]).map(({dto:{name:C,type:$},meta:B})=>({label:C,value:$,description:B?.description,isDisabled:B?!B.enabled:!1,imgUrl:B?.iconUrl})),[v]),f=async()=>{await fe(),Object.keys(ee.errors).length===0&&r&&r()},T=v.find(({dto:{type:C}})=>C===re),de=T?.dto.options.filter(C=>C.required),H=T?.dto.options.filter(C=>!C.required),ye=`contact-point-type-${o}`;return t.createElement("div",{className:b.wrapper,"data-testid":"item-container"},t.createElement("div",{className:b.topRow},t.createElement("div",null,t.createElement(U.D,{label:"Integration",htmlFor:ye,"data-testid":`${o}type`},t.createElement(N.xI,{name:h("type"),defaultValue:a.type,render:({field:{ref:C,onChange:$,...B}})=>t.createElement(d.l6,{disabled:!i,inputId:ye,...B,width:37,options:y,onChange:Ee=>$(Ee?.value)}),control:q,rules:{required:!0}}))),t.createElement("div",{className:b.buttons},D&&r&&Ce&&t.createElement(I.$n,{disabled:le,size:"xs",variant:"secondary",type:"button",onClick:()=>f(),icon:le?"spinner":"message"},"Test"),i&&t.createElement(t.Fragment,null,t.createElement(I.$n,{size:"xs",variant:"secondary",type:"button",onClick:()=>p(),icon:"copy"},"Duplicate"),E&&t.createElement(I.$n,{"data-testid":`${o}delete-button`,size:"xs",variant:"secondary",type:"button",onClick:()=>E(),icon:"trash-alt"},"Delete")))),T&&t.createElement("div",{className:b.innerContent},t.createElement(K,{defaultValues:a,selectedChannelOptions:de?.length?de:H,secureFields:ce,errors:S,onResetSecureField:te,pathPrefix:o,readOnly:!i,customValidators:M}),!!(de?.length&&H?.length)&&t.createElement(Z.i,{label:`Optional ${T.dto.name} settings`},T.dto.info!==""&&t.createElement(x.F,{title:"",severity:"info"},T.dto.info),t.createElement(K,{defaultValues:a,selectedChannelOptions:H,secureFields:ce,onResetSecureField:te,errors:S,pathPrefix:o,readOnly:!i,customValidators:M})),t.createElement(Z.i,{label:"Notification settings"},t.createElement(u,{pathPrefix:o,readOnly:!i}))))}const Y=a=>({buttons:(0,n.css)({"& > * + *":{marginLeft:a.spacing(1)}}),innerContent:(0,n.css)({maxWidth:"536px"}),wrapper:(0,n.css)({margin:a.spacing(2,0),padding:a.spacing(1),border:`solid 1px ${a.colors.border.medium}`,borderRadius:a.shape.radius.default,maxWidth:`${a.breakpoints.values.xl}${a.breakpoints.unit}`}),topRow:(0,n.css)({display:"flex",flexDirection:"row",justifyContent:"space-between"}),channelSettingsHeader:(0,n.css)({marginTop:a.spacing(2)})});function A({pathPrefix:a}){const{register:s}=(0,N.xW)();return(0,t.useEffect)(()=>{s(`${a}.__id`),s(`${a}.__deleted`)},[s,a]),t.createElement(t.Fragment,null)}function G(a){if(a)return{...a,items:a.items.map(s=>({...s,settings:{...s.settings,http_config:s.settings?.http_config?me(s.settings?.http_config):void 0}}))}}function me(a){return ue(a)?a:{...(0,F.omit)(a,"authorization"),bearer_token:a.authorization?.credentials,bearer_token_file:a.authorization?.credentials_file}}function ue(a){return["bearer_token","bearer_token_file"].some(s=>s in a)}function ie({config:a,initialValues:s,defaultItem:o,notifiers:p,alertManagerSourceName:E,onSubmit:r,onTestChannel:v,takenReceiverNames:S,commonSettingsComponent:j,isEditable:u,isTestable:i,customValidators:D}){const M=(0,z._2)(),b=(0,L.of)(ge),q=G(s)??{name:"",items:[{...o,__id:String(Math.random())}]},R=(0,N.mN)({defaultValues:structuredClone(q)});(0,w.o)(y=>y.unifiedAlerting.saveAMConfig=m.jA);const{handleSubmit:_,register:fe,formState:{errors:ee,isSubmitting:Q},getValues:re}=R,{fields:le,append:ve,remove:Ce}=(0,oe.r)({name:"items",formAPI:R,softDelete:!0}),ce=(0,t.useCallback)(y=>S.map(f=>f.trim().toLowerCase()).includes(y.trim().toLowerCase())?"Another receiver with this name already exists.":!0,[S]),g=async y=>{try{await r({...y,items:y.items.filter(f=>!f.__deleted)})}catch(f){if(f instanceof Error||(0,ae.NF)(f)){M.error("Failed to save the contact point",l(f));const T=new Error("Failed to save the contact point");T.cause=f,(0,se.vV)(T)}throw f}},te=()=>{M.error("There are errors in the form. Please correct them and try again!")};return t.createElement(N.Op,{...R},!a.alertmanager_config.route&&t.createElement(x.F,{severity:"warning",title:"Attention"},"Because there is no default policy configured yet, this contact point will automatically be set as default."),t.createElement("form",{onSubmit:_(g,te)},t.createElement("h4",{className:b.heading},u?s?"Update contact point":"Create contact point":"Contact point"),t.createElement(U.D,{label:"Name",invalid:!!ee.name,error:ee.name&&ee.name.message,required:!0},t.createElement(O.p,{readOnly:!u,id:"name",...fe("name",{required:"Name is required",validate:{nameIsAvailable:ce}}),width:39,placeholder:"Name"})),le.map((y,f)=>{const T=`items.${f}.`;if(y.__deleted)return t.createElement(A,{key:y.__id,pathPrefix:T});const de=s?.items.find(({__id:H})=>H===y.__id);return t.createElement(k,{defaultValues:y,initialValues:de,key:y.__id,onDuplicate:()=>{const H=re().items[f];ve({...H,__id:String(Math.random())})},onTest:v?()=>{const H=re().items[f];v(H)}:void 0,onDelete:()=>Ce(f),pathPrefix:T,notifiers:p,secureFields:de?.secureFields,errors:ee?.items?.[f],commonSettingsComponent:j,isEditable:u,isTestable:i,customValidators:D?D[y.type]:void 0})}),t.createElement(t.Fragment,null,u&&t.createElement(I.$n,{type:"button",icon:"plus",variant:"secondary",onClick:()=>ve({...o,__id:String(Math.random())})},"Add contact point integration"),t.createElement("div",{className:b.buttons},u&&t.createElement(t.Fragment,null,Q&&t.createElement(I.$n,{disabled:!0,icon:"spinner",variant:"primary"},"Saving..."),!Q&&t.createElement(I.$n,{type:"submit"},"Save contact point")),t.createElement(I.z9,{disabled:Q,variant:"secondary","data-testid":"cancel-button",href:(0,c.nL)("alerting/notifications",E)},"Cancel")))))}const ge=a=>({heading:(0,n.css)({margin:a.spacing(4,0)}),buttons:(0,n.css)({marginTop:a.spacing(4),"& > * + *":{marginLeft:a.spacing(1)}})});function l(a){return(0,X.uz)(a)?a.data.detail:(0,J.q)(a)}},59647:(pe,ne,e)=>{e.d(ne,{U0:()=>w,VY:()=>oe});var n=e(1932),t=e(96540),N=e(17172),ae=e(3169),L=e(26423),x=e(12210),U=e(99494),O=e(79851),I=e(86768),z=e(37534),w=(c=>(c.NewIntegration="new_oncall_integration",c.ExistingIntegration="existing_oncall_integration",c))(w||{}),J=(c=>(c.IntegrationType="integration_type",c.IntegrationName="integration_name",c))(J||{}),se=(c=>(c.Disabled="disabled",c.V1="v1",c.V2="v2",c))(se||{});function X(){const{installed:c,loading:m,error:F}=(0,x._)(U.W.OnCall),{data:d=[],error:W,isLoading:P}=L.WG.endpoints.features.useQuery(void 0,{skip:!c}),V=(0,t.useMemo)(()=>c?d.includes(L.Pc)?"v2":"v1":"disabled",[c,d]),K=(0,t.useMemo)(()=>V==="v2",[V]);return{isOnCallEnabled:c,integrationStatus:V,isAlertingV2IntegrationEnabled:K,isOnCallStatusLoading:m||P,onCallError:F??W}}function oe(){const c=(0,ae._2)(),{isOnCallEnabled:m,integrationStatus:F,isAlertingV2IntegrationEnabled:d,isOnCallStatusLoading:W,onCallError:P}=X(),{useCreateIntegrationMutation:V,useGrafanaOnCallIntegrationsQuery:K,useLazyValidateIntegrationNameQuery:Z}=L.WG,[k,{isFetching:Y}]=Z(),[A]=V(),{data:G=[],isLoading:me,isError:ue}=K(void 0,{skip:!d}),ie=(0,t.useMemo)(()=>({integration_name:async s=>{try{return await k(s).unwrap(),!0}catch(o){if((0,N.NF)(o)&&o.status===409)return"Integration of this name already exists in OnCall";throw c.error("Failed to validate OnCall integration name. Is the OnCall API available?"),o}},url:s=>d?G.map(o=>o.integration_url).includes(s)?!0:"Selection of existing OnCall integration is required":!0}),[G,k,d,c]),ge=(0,t.useCallback)(s=>d?(0,n.jM)(s,o=>{o.grafana_managed_receiver_configs?.forEach(p=>{p.type===z.J4.OnCall&&(p.settings.integration_type="existing_oncall_integration")})}):s,[d]),l=(0,t.useCallback)(async s=>{if(!d)return s;const E=(s.grafana_managed_receiver_configs?.filter(r=>r.type==="oncall")??[]).filter(r=>r.settings.integration_type==="new_oncall_integration").map(async r=>{const v=await A({integration:z.FI,verbal_name:r.settings.integration_name}).unwrap();r.settings.url=v.integration_url});return await Promise.all(E),(0,n.jM)(s,r=>{r.grafana_managed_receiver_configs?.forEach(v=>{v.type===z.J4.OnCall&&(delete v.settings.integration_type,delete v.settings.integration_name)})})},[d,A]),a=(0,t.useCallback)(s=>{if(s.type===z.J4.OnCall&&d){const o=s.options.filter(r=>r.propertyName!=="url"),p={value:"new_oncall_integration",label:"New OnCall integration",description:"A new OnCall integration without escalation chains will be automatically created"},E={value:"existing_oncall_integration",label:"Existing OnCall integration",description:"Use an existing OnCall integration"};return o.unshift((0,O.u)("integration_type","How to connect to OnCall","",{required:!0,element:"radio",defaultValue:p,selectOptions:[p,E]}),(0,O.u)("integration_name","Integration name","The name of the new OnCall integration",{required:!0,showWhen:{field:"integration_type",is:"new_oncall_integration"}}),(0,O.u)("url","OnCall Integration","The OnCall integration to send alerts to",{element:"select",required:!0,showWhen:{field:"integration_type",is:"existing_oncall_integration"},selectOptions:G.map(r=>({label:r.display_name,description:r.integration_url,value:r.integration_url}))})),{...s,options:o}}return s},[G,d]);return{integrationStatus:F,onCallNotifierMeta:{enabled:!!m,order:-1,description:m?"Connect effortlessly to Grafana OnCall":"Enable Grafana OnCall plugin to use this integration",iconUrl:I.K[U.W.OnCall]},extendOnCallNotifierFeatures:a,extendOnCallReceivers:ge,createOnCallIntegrations:l,onCallFormValidators:ie,isLoadingOnCallIntegration:me||W,isValidating:Y,hasOnCallError:!!P||ue}}}}]);

//# sourceMappingURL=7455.fa8812bf0d0acf3457bc.js.map