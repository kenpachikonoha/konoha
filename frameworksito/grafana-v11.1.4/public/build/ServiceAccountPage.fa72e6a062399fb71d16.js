"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[6576],{82936:(Ee,k,a)=>{a.r(k),a.d(k,{ServiceAccountPageUnconnected:()=>pe,default:()=>Re});var e=a(96540),s=a(71468),y=a(1933),T=a(67061),p=a(55852),g=a(29158),i=a(96374),h=a(67608),v=a(10096),c=a(31678),K=a(52487),F=a(16233);const Q=t=>{const n=F.TP.hasPermissionInMetadata(c.AccessControlAction.ServiceAccountsPermissionsWrite,t.serviceAccount);return e.createElement(K.x,{title:"Permissions",addPermissionTitle:"Add permission",buttonLabel:"Add permission",resource:"serviceaccounts",resourceId:t.serviceAccount.id,canSetPermissions:n})};var X=a(98788),u=a(32196),N=a(72724),m=a(40845),D=a(60029),l=a(72109),r=a(85927),O=a(91634),S=a(10354),A=a(82702);const R=({label:t,value:n,inputType:o,disabled:E,onChange:f})=>{const x=(0,e.useRef)(null),[d,U]=(0,e.useState)(n),[b,C]=(0,e.useState)(!1),B=(0,m.of)(V),ae=`${t}-input`;(0,e.useEffect)(()=>{b&&ue()},[b]);const oe=()=>{C(!0)},ie=()=>{C(!1),U(n||"")},se=(w,W)=>{W!==O.O.Invalid&&U(w.target.value)},de=(w,W)=>{W!==O.O.Invalid&&U(w.target.value)},ue=()=>{x?.current?.focus()},me=()=>{C(!1),f&&f(d)};return e.createElement("tr",null,e.createElement("td",null,e.createElement(D.J,{htmlFor:ae},t)),e.createElement("td",{className:"width-25",colSpan:2},!E&&b?e.createElement(S.p,{id:ae,type:o,defaultValue:n,onBlur:de,onChange:se,ref:x,width:30}):e.createElement("span",{className:(0,u.cx)({[B.disabled]:E})},n)),e.createElement("td",null,f&&e.createElement(A.Z,{closeOnConfirm:!0,confirmText:"Save",onConfirm:me,onClick:oe,onCancel:ie,disabled:E},"Edit")))},V=t=>({disabled:(0,u.css)`
      color: ${t.colors.text.secondary};
    `});var $=a(89062),z=a(5133);const J=({label:t,serviceAccount:n,roleOptions:o,onRoleChange:E})=>{const f=`${t}-input`,x=v.contextSrv.hasPermissionInMetadata(c.AccessControlAction.ServiceAccountsWrite,n);return e.createElement("tr",null,e.createElement("td",null,e.createElement(D.J,{htmlFor:f},t)),v.contextSrv.licensedAccessControlEnabled()?e.createElement("td",{colSpan:3},e.createElement($.y,{userId:n.id,orgId:n.orgId,basicRole:n.role,onBasicRoleChange:E,roleOptions:o,basicRoleDisabled:!x,disabled:n.isExternal||n.isDisabled})):e.createElement(e.Fragment,null,e.createElement("td",null,e.createElement(z.r,{width:24,inputId:f,"aria-label":"Role",value:n.role,disabled:n.isExternal||n.isDisabled,onChange:E})),e.createElement("td",{colSpan:2})))};function P({serviceAccount:t,timeZone:n,onChange:o}){const E=(0,m.of)(I),f=v.contextSrv.hasPermission(c.AccessControlAction.ServiceAccountsWrite),[x,d]=e.useState([]),U=C=>{o({...t,role:C})},b=C=>{o({...t,name:C})};return e.useEffect(()=>{async function C(){try{if(v.contextSrv.hasPermission(c.AccessControlAction.ActionRolesList)){let B=await(0,r.RL)(t.orgId);d(B)}}catch{console.error("Error loading options for service account")}}v.contextSrv.licensedAccessControlEnabled()&&C()},[t.orgId]),e.createElement("div",{className:E.section},e.createElement("h3",null,"Information"),e.createElement("table",{className:"filter-table"},e.createElement("tbody",null,e.createElement(R,{label:"Name",value:t.name,onChange:t.isExternal?void 0:b,disabled:!f||t.isDisabled}),e.createElement(R,{label:"ID",value:t.login,disabled:t.isDisabled}),e.createElement(J,{label:"Roles",serviceAccount:t,onRoleChange:U,roleOptions:x}),e.createElement(R,{label:"Creation date",value:(0,N.LE)(t.createdAt,{timeZone:n}),disabled:t.isDisabled}),t.isExternal&&t.requiredBy&&e.createElement("tr",null,e.createElement("td",null,e.createElement(D.J,null,"Used by")),e.createElement("td",null,e.createElement(l.Y,{href:`/plugins/${t.requiredBy}`},t.requiredBy))))))}const I=t=>({section:(0,u.css)`
    margin-bottom: ${t.spacing(4)};
  `});var j=a(91605),Z=a(56034),_=a(14578);const ee=({tokens:t,timeZone:n,tokenActionsDisabled:o,onDelete:E})=>{const f=(0,m.$j)(),x=L(f);return e.createElement("table",{className:(0,u.cx)(x.section,"filter-table")},e.createElement("thead",null,e.createElement("tr",null,e.createElement("th",null,"Name"),e.createElement("th",null,"Expires"),e.createElement("th",null,"Created"),e.createElement("th",null,"Last used at"),e.createElement("th",null),e.createElement("th",null))),e.createElement("tbody",null,t.map(d=>e.createElement("tr",{key:d.id,className:x.tableRow(d.hasExpired||d.isRevoked)},e.createElement("td",null,d.name),e.createElement("td",null,e.createElement(le,{timeZone:n,token:d})),e.createElement("td",null,te(n,d.created)),e.createElement("td",null,H(n,d.lastUsedAt)),e.createElement("td",{className:"width-1 text-center"},d.isRevoked&&e.createElement(q,null)),e.createElement("td",null,e.createElement(j.e,{"aria-label":`Delete service account token ${d.name}`,size:"sm",onConfirm:()=>E(d),disabled:o}))))))};function H(t,n){return n?(0,N.LE)(n,{timeZone:t}):"Never"}function te(t,n){return n?(0,N.LE)(n,{timeZone:t}):"No expiration date"}function re(t){const n=Math.ceil(t/86400);return`Expires in ${n>1?`${n} days`:`${n} day`}`}const q=()=>{const t=(0,m.of)(L);return e.createElement("span",{className:t.hasExpired},"Revoked",e.createElement("span",{className:t.tooltipContainer},e.createElement(Z.m,{content:"This token has been publicly exposed. Please rotate this token"},e.createElement(_.I,{name:"exclamation-triangle",className:t.toolTipIcon}))))},le=({timeZone:t,token:n})=>{const o=(0,m.of)(L);return n.expiration?n.secondsUntilExpiration?e.createElement("span",{className:o.secondsUntilExpiration},re(n.secondsUntilExpiration)):n.hasExpired?e.createElement("span",{className:o.hasExpired},"Expired",e.createElement("span",{className:o.tooltipContainer},e.createElement(Z.m,{content:"This token has expired"},e.createElement(_.I,{name:"exclamation-triangle",className:o.toolTipIcon})))):e.createElement("span",null,te(t,n.expiration)):e.createElement("span",{className:o.neverExpire},"Never")},L=t=>({tableRow:n=>(0,u.css)`
    color: ${n?t.colors.text.secondary:t.colors.text.primary};
  `,tooltipContainer:(0,u.css)`
    margin-left: ${t.spacing(1)};
  `,toolTipIcon:(0,u.css)`
    color: ${t.colors.error.text};
  `,secondsUntilExpiration:(0,u.css)`
    color: ${t.colors.warning.text};
  `,hasExpired:(0,u.css)`
    color: ${t.colors.error.text};
  `,neverExpire:(0,u.css)`
    color: ${t.colors.text.secondary};
  `,section:(0,u.css)`
    margin-bottom: ${t.spacing(4)};
  `});var ve=a(12966),Y=a(17172),Te=a(12131),xe=a(80714),ne=a(1936);const G="/api/serviceaccounts";function fe(t){return async n=>{n((0,ne.G3)());try{const o=await(0,Y.AI)().get(`${G}/${t}`,(0,xe.F)());n((0,ne.QM)(o))}catch(o){console.error(o)}finally{n((0,ne.aD)())}}}function Ae(t){return async n=>{await(0,Y.AI)().patch(`${G}/${t.id}?accesscontrol=true`,{...t}),n(fe(t.id))}}function ye(t){return async()=>{await(0,Y.AI)().delete(`${G}/${t}`),Te.Ny.push("/org/serviceaccounts")}}function he(t,n,o){return async E=>{const f=await(0,Y.AI)().post(`${G}/${t}/tokens`,n);o(f.key),E(ce(t))}}function Pe(t,n){return async o=>{await(0,Y.AI)().delete(`${G}/${t}/tokens/${n}`),o(ce(t))}}function ce(t){return async n=>{try{const o=await(0,Y.AI)().get(`${G}/${t}/tokens`);n((0,ne.ch)(o))}catch(o){console.error(o)}}}function Ie(t){return{serviceAccount:t.serviceAccountProfile.serviceAccount,tokens:t.serviceAccountProfile.tokens,isLoading:t.serviceAccountProfile.isLoading,timezone:(0,y.O)(t.user)}}const Me={createServiceAccountToken:he,deleteServiceAccount:ye,deleteServiceAccountToken:Pe,loadServiceAccount:fe,loadServiceAccountTokens:ce,updateServiceAccount:Ae},Oe=(0,s.connect)(Ie,Me),pe=({match:t,serviceAccount:n,tokens:o,timezone:E,isLoading:f,createServiceAccountToken:x,deleteServiceAccount:d,deleteServiceAccountToken:U,loadServiceAccount:b,loadServiceAccountTokens:C,updateServiceAccount:B})=>{const[ae,oe]=(0,e.useState)(""),[ie,se]=(0,e.useState)(!1),[de,ue]=(0,e.useState)(!1),[me,w]=(0,e.useState)(!1),W=parseInt(t.params.id,10),De=n.isDisabled||n.isExternal||!v.contextSrv.hasPermission(c.AccessControlAction.ServiceAccountsWrite),Se=v.contextSrv.hasPermission(c.AccessControlAction.ServiceAccountsWrite),$e=v.contextSrv.hasPermissionInMetadata(c.AccessControlAction.ServiceAccountsPermissionsRead,n),Le={text:n.name,img:n.avatarUrl,subTitle:"Manage settings for an individual service account."};(0,e.useEffect)(()=>{b(W),C(W),v.contextSrv.licensedAccessControlEnabled()&&(0,ve.pJ)()},[b,C,W]);const be=M=>{B(M)},ge=M=>()=>{ue(M)},Ce=M=>()=>{w(M)},Be=()=>{d(n.id)},Ne=()=>{B({...n,isDisabled:!0}),w(!1)},Ue=()=>{B({...n,isDisabled:!1})},We=M=>{U(n?.id,M.id)},ke=M=>{x(n?.id,M,oe)},Ke=()=>{se(!1),oe("")};return e.createElement(h.Y,{navId:"serviceaccounts",pageNav:Le},e.createElement(h.Y.Contents,{isLoading:f},e.createElement("div",null,n&&!n.isExternal&&e.createElement(T.B,{gap:2,height:"auto",justifyContent:"flex-end"},e.createElement(p.$n,{type:"button",variant:"destructive",onClick:ge(!0),disabled:!v.contextSrv.hasPermission(c.AccessControlAction.ServiceAccountsDelete)},"Delete service account"),n.isDisabled?e.createElement(p.$n,{type:"button",variant:"secondary",onClick:Ue,disabled:!Se},"Enable service account"):e.createElement(p.$n,{type:"button",variant:"secondary",onClick:Ce(!0),disabled:!Se},"Disable service account")),n&&n.isExternal&&e.createElement(T.B,{gap:2,height:"auto",justifyContent:"flex-end"},e.createElement(g.K,{disabled:!0,name:"lock",size:"md",tooltip:"This is a managed service account and cannot be modified."})),n&&e.createElement(P,{serviceAccount:n,timeZone:E,onChange:be}),e.createElement(T.B,{justifyContent:"space-between",height:"auto"},e.createElement("h3",null,"Tokens"),!n.isExternal&&e.createElement(p.$n,{onClick:()=>se(!0),disabled:De},"Add service account token")),o&&e.createElement(ee,{tokens:o,timeZone:E,onDelete:We,tokenActionsDisabled:De}),!n.isExternal&&$e&&e.createElement(Q,{serviceAccount:n})),e.createElement(i.u,{isOpen:de,title:"Delete service account",body:"Are you sure you want to delete this service account?",confirmText:"Delete service account",onConfirm:Be,onDismiss:ge(!1)}),e.createElement(i.u,{isOpen:me,title:"Disable service account",body:"Are you sure you want to disable this service account?",confirmText:"Disable service account",onConfirm:Ne,onDismiss:Ce(!1)}),e.createElement(X.z,{isOpen:ie,token:ae,serviceAccountLogin:n.login,onCreateToken:ke,onClose:Ke})))},Re=Oe(pe)},98788:(Ee,k,a)=>{a.d(k,{z:()=>X});var e=a(32196),s=a(96540),y=a(62938),T=a(32264),p=a(40845),g=a(37390),i=a(88575),h=a(10354),v=a(94354),c=a(98239),K=a(55852),F=a(10534);const Q=[{label:"No expiration",value:!1},{label:"Set expiration date",value:!0}],X=({isOpen:m,token:D,serviceAccountLogin:l,onCreateToken:r,onClose:O})=>{const S=new Date;S.setDate(S.getDate()+1);const A=new Date;T.$.tokenExpirationDayLimit!==void 0&&T.$.tokenExpirationDayLimit>-1?A.setDate(A.getDate()+T.$.tokenExpirationDayLimit+1):A.setDate(864e13);const R=T.$.tokenExpirationDayLimit!==void 0&&T.$.tokenExpirationDayLimit>0,[V,$]=(0,s.useState)(""),[z,J]=(0,s.useState)(""),[P,I]=(0,s.useState)(R),[j,Z]=(0,s.useState)(S),[_,ee]=(0,s.useState)(j!==""),H=(0,p.of)(N);(0,s.useEffect)(()=>{m&&$(`${l}-${(0,y.A)()}`)},[l,m]);const te=L=>{ee(L!==""),Z(L)},re=()=>{r({name:z||V,secondsToLive:P?u(j):void 0})},q=()=>{J(""),$(""),I(R),Z(S),ee(j!==""),O()},le=D?"Service account token created":"Add service account token";return s.createElement(g.a,{isOpen:m,title:le,onDismiss:q,className:H.modal},D?s.createElement(s.Fragment,null,s.createElement(i.D,{label:"Token",description:"Copy the token now as you will not be able to see it again. Losing a token requires creating a new one."},s.createElement("div",{className:H.modalTokenRow},s.createElement(h.p,{name:"tokenValue",value:D,readOnly:!0}),s.createElement(F.b,{className:H.modalCopyToClipboardButton,variant:"primary",size:"md",icon:"copy",getText:()=>D},"Copy clipboard"))),s.createElement(g.a.ButtonRow,null,s.createElement(F.b,{variant:"primary",getText:()=>D,onClipboardCopy:q},"Copy to clipboard and close"),s.createElement(K.$n,{variant:"secondary",onClick:q},"Close"))):s.createElement("div",null,s.createElement(i.D,{label:"Display name",description:"Name to easily identify the token",required:!0},s.createElement(h.p,{name:"tokenName",value:z,placeholder:V,onChange:L=>{J(L.currentTarget.value)}})),s.createElement(i.D,{label:"Expiration"},s.createElement(v.z,{options:Q,value:P,onChange:I,size:"md"})),P&&s.createElement(i.D,{label:"Expiration date"},s.createElement(c.l,{onChange:te,value:j,placeholder:"",minDate:S,maxDate:A})),s.createElement(g.a.ButtonRow,null,s.createElement(K.$n,{onClick:re,disabled:P&&!_},"Generate token"))))},u=m=>{const D=new Date(m),l=new Date;return Math.ceil((D.getTime()-l.getTime())/1e3)},N=m=>({modal:(0,e.css)({width:"550px"}),modalTokenRow:(0,e.css)({display:"flex"}),modalCopyToClipboardButton:(0,e.css)({marginLeft:m.spacing(.5)})})},12966:(Ee,k,a)=>{a.d(k,{W4:()=>Q,iJ:()=>c,mV:()=>F,nM:()=>N,pJ:()=>v,qS:()=>m,yC:()=>X,yd:()=>D});var e=a(2543),s=a.n(e),y=a(17172),T=a(85927),p=a(16233),g=a(31678),i=a(1936);const h="/api/serviceaccounts";function v(){return async l=>{try{if(p.TP.licensedAccessControlEnabled()&&p.TP.hasPermission(g.AccessControlAction.ActionRolesList)){const r=await(0,T.RL)();l((0,i.ew)(r))}}catch(r){console.error(r)}}}function c({withLoadingIndicator:l}={withLoadingIndicator:!1}){return async(r,O)=>{try{if(p.TP.hasPermission(g.AccessControlAction.ServiceAccountsRead)){l&&r((0,i.FW)());const{perPage:S,page:A,query:R,serviceAccountStateFilter:V}=O().serviceAccounts,$=await(0,y.AI)().get(`/api/serviceaccounts/search?perpage=${S}&page=${A}&query=${R}${u(V)}&accesscontrol=true`);if(p.TP.licensedAccessControlEnabled()&&p.TP.hasPermission(g.AccessControlAction.ActionUserRolesList)){r((0,i.dJ)());const z=p.TP.user.orgId,J=$?.serviceAccounts.map(I=>I.id),P=await(0,y.AI)().post("/api/access-control/users/roles/search",{userIds:J,orgId:z});$.serviceAccounts.forEach(I=>{I.roles=P?P[I.id]||[]:[]}),r((0,i.jE)())}r((0,i.zh)($))}}catch(S){console.error(S)}finally{r((0,i.Yh)())}}}const K=(0,e.debounce)(l=>l(c()),500,{leading:!0});function F(l){return async r=>{await(0,y.AI)().patch(`${h}/${l.id}?accesscontrol=true`,{...l}),r(c())}}function Q(l){return async r=>{await(0,y.AI)().delete(`${h}/${l}`),r(c())}}function X(l,r,O){return async S=>{const A=await(0,y.AI)().post(`${h}/${l}/tokens`,r);O(A.key),S(c())}}const u=l=>{switch(l){case g.ServiceAccountStateFilter.WithExpiredTokens:return"&expiredTokens=true";case g.ServiceAccountStateFilter.Disabled:return"&disabled=true";case g.ServiceAccountStateFilter.External:return"&external=true";default:return""}};function N(l){return async r=>{r((0,i.L5)(l)),K(r)}}function m(l){return async r=>{r((0,i.c3)(l)),r(c())}}function D(l){return async r=>{r((0,i.EC)(l)),r(c())}}}}]);

//# sourceMappingURL=ServiceAccountPage.fa72e6a062399fb71d16.js.map