"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[1121],{31121:(Y,I,a)=>{a.r(I),a.d(I,{default:()=>be,getStyles:()=>Q});var d=a(32196),y=a(2543),e=a(96540),C=a(49785),E=a(47232),f=a(40845),T=a(42418),p=a(67061),D=a(56034),S=a(14578),V=a(55852),Z=a(88575),w=a(60029),k=a(10354),q=a(49962);const _=q.H.injectEndpoints({endpoints:t=>({getRuleHistory:t.query({query:({ruleUid:n,from:s,to:r,limit:c=100})=>({url:"/api/v1/rules/history",params:{ruleUID:n,from:s,to:r,limit:c}})})})});var x=a(98164),ee=a(69087),te=a(35108),ae=a(72095),ne=a(72724),se=a(64149),re=a(8406),j=a(30423),O=a(70026);function oe(t){const n=t.reduce((s,r)=>{const c=s.get(r.timestamp);return c?c.push(r):s.set(r.timestamp,[r]),s},new Map);return new Map([...n].sort((s,r)=>r[0]-s[0]))}const z=e.memo(({records:t,commonLabels:n,onLabelClick:s,onRecordsRendered:r})=>{const c=(0,f.of)(F),i=oe(t),o=new Map;return(0,e.useEffect)(()=>{r&&r(o)}),e.createElement("ul",{className:c.logsScrollable,"aria-label":"State history by timestamp"},Array.from(i.entries()).map(([m,h])=>e.createElement("li",{id:m.toString(10),key:m,"data-testid":m,ref:l=>l&&o.set(m,l),className:c.listItemWrapper},e.createElement(le,{time:m}),e.createElement("div",{className:c.logsContainer},h.map(({line:l})=>e.createElement(e.Fragment,{key:(0,y.uniqueId)()},e.createElement(j.C,{state:l.previous,size:"sm",muted:!0}),e.createElement(S.I,{name:"arrow-right",size:"sm"}),e.createElement(j.C,{state:l.current}),e.createElement(p.B,null,l.values&&e.createElement(A,{record:l.values})),e.createElement("div",null,l.labels&&e.createElement(se.L,{tags:(0,O.$)(Object.entries(l.labels),n).map(([g,L])=>`${g}=${L}`),onClick:s}))))))))});z.displayName="LogRecordViewerByTimestamp";function Ce({records:t,commonLabels:n}){const s=useStyles2(F),r=groupBy(t,c=>JSON.stringify(c.line.labels));return React.createElement(React.Fragment,null,Object.entries(r).map(([c,i])=>React.createElement(Stack,{direction:"column",key:c},React.createElement("h4",null,React.createElement(TagList,{tags:omitLabels(Object.entries(i[0].line.labels??{}),n).map(([o,m])=>`${o}=${m}`)})),React.createElement("div",{className:s.logsContainer},i.map(({line:o,timestamp:m})=>React.createElement("div",{key:uniqueId()},React.createElement(AlertStateTag,{state:o.previous,size:"sm",muted:!0}),React.createElement(Icon,{name:"arrow-right",size:"sm"}),React.createElement(AlertStateTag,{state:o.current}),React.createElement(Stack,null,o.values&&React.createElement(A,{record:o.values})),React.createElement("div",null,dateTimeFormat(m))))))))}const le=({time:t})=>{const n=new Date(t),s=(0,f.of)(F);return e.createElement("div",{className:s.timestampWrapper},e.createElement(p.B,{alignItems:"center",gap:1},e.createElement(S.I,{name:"clock-nine",size:"sm"}),e.createElement("span",{className:s.timestampText},(0,ne.LE)(n)),e.createElement("small",null,"(",(0,ae.B)(n)," ago)")))},A=e.memo(({record:t})=>{const n=Object.entries(t);return e.createElement(e.Fragment,null,n.map(([s,r])=>e.createElement(re.J,{key:s,label:s,value:r})))});A.displayName="AlertInstanceValues";const F=t=>({logsContainer:(0,d.css)({display:"grid",gridTemplateColumns:"max-content max-content max-content auto max-content",gap:t.spacing(2,1),alignItems:"center"}),logsScrollable:(0,d.css)({height:"500px",overflow:"scroll",flex:1}),timestampWrapper:(0,d.css)({color:t.colors.text.secondary}),timestampText:(0,d.css)({color:t.colors.text.primary,fontSize:t.typography.bodySmall.fontSize,fontWeight:t.typography.fontWeightBold}),listItemWrapper:(0,d.css)({background:"transparent",outline:"1px solid transparent",padding:`${t.spacing(1)} ${t.spacing(1.5)}`,[t.transitions.handleMotion("no-preference","reduce")]:{transition:"background 150ms, outline 150ms"}})});var ce=a(70713),W=a(52622),ie=a(82389),me=a(28895);const ue=t=>t,J=e.memo(({frames:t,timeRange:n})=>{const s=(0,f.$j)();return e.createElement(ce.Ay,{disableHeight:!0},({width:r})=>e.createElement(ie.I,{frames:t,timeRange:n,timeZone:"browser",mode:me.pm.Changes,height:18*t.length+50,width:r,showValue:W.yL.Never,theme:s,rowHeight:.8,legend:{calcs:[],displayMode:W.lm.List,placement:"bottom",showLegend:!0},legendItems:[{label:"Normal",color:s.colors.success.main,yAxis:1},{label:"Pending",color:s.colors.warning.main,yAxis:1},{label:"Alerting",color:s.colors.error.main,yAxis:1},{label:"NoData",color:s.colors.info.main,yAxis:1},{label:"Mixed",color:s.colors.text.secondary,yAxis:1}],replaceVariables:ue}))});J.displayName="LogTimelineViewer";var H=a(11261),de=a(57875),ge=a(48241),P=a(73134);function pe(t,n){const s=(0,f.$j)();return(0,e.useMemo)(()=>{const r=t?.data?.values[0]??[],c=fe(r)?r:[],i=t?.data?.values[1]??[],o=c.reduce((u,v,$)=>{const R=i[$];return ye(R)&&u.push({timestamp:v,line:R}),u},[]),m=(0,y.groupBy)(o,u=>JSON.stringify(u.line.labels)),l=Object.keys(m).map(u=>Object.entries(JSON.parse(u))),g=(0,O.Q)(l),L=n?(0,x.J$)(n):[],M=Object.entries(m).filter(([u])=>{const v=JSON.parse(u);return(0,x.Av)(v,L)}).map(([u,v])=>Ee(u,v,g,s));return{historyRecords:o.filter(({line:u})=>u.labels&&(0,x.Av)(u.labels,L)),dataFrames:M,commonLabels:g,totalRecordsCount:o.length}},[t,n,s])}function fe(t){return t.every(n=>typeof n=="number")}function ye(t){return typeof t=="object"&&t!==null&&"current"in t&&"previous"in t}function Ee(t,n,s,r){const c=Object.entries(JSON.parse(t)),i={name:"time",type:H.PU.time,values:[...n.map(l=>l.timestamp),Date.now()],config:{displayName:"Time",custom:{fillOpacity:100}}},o=i.values.map((l,g)=>g);o.sort((0,ge.i)(i));const m=[...n.map(l=>l.line.current),n.at(-1)?.line.current],h={fields:[{...i,values:i.values.map((l,g)=>i.values[o[g]])},{name:"state",type:H.PU.string,values:m.map((l,g)=>m[o[g]]),config:{displayName:(0,O.$)(c,s).map(([l,g])=>`${l}=${g}`).join(", "),color:{mode:"thresholds"},custom:{fillOpacity:100},mappings:[{type:P.dM.ValueToText,options:{Alerting:{color:r.colors.error.main},Pending:{color:r.colors.warning.main},Normal:{color:r.colors.success.main},NoData:{color:r.colors.info.main}}}],thresholds:{mode:P.Ol.Absolute,steps:[]}}}],length:i.values.length,name:t};return h.fields.forEach(l=>{l.display=(0,de.J)({field:l,theme:r})}),h}const he=10*1e3,ve=12,Se=({ruleUID:t})=>{const n=(0,f.of)(Q),[s,r]=(0,e.useState)(""),c=(0,e.useRef)(new Map),{getValues:i,setValue:o,register:m,handleSubmit:h}=(0,C.mN)({defaultValues:{query:""}}),{useGetRuleHistoryQuery:l}=_,g=(0,e.useMemo)(()=>Re(),[]),{currentData:L,isLoading:K,isError:M,error:u}=l({ruleUid:t,from:g.from.unix(),to:g.to.unix(),limit:250},{refetchOnFocus:!0,refetchOnReconnect:!0,pollingInterval:he}),{dataFrames:v,historyRecords:$,commonLabels:R,totalRecordsCount:B}=pe(L,s),{frameSubset:N,frameTimeRange:Ie}=Le(v),Te=(0,e.useCallback)(b=>{const X=(0,x.EU)(i("query"),b);r(X),o("query",X)},[r,o,i]),G=(0,e.useCallback)(()=>{r(""),o("query","")},[r,o]);if(K)return e.createElement("div",null,"Loading...");if(M)return e.createElement(T.F,{title:"Error fetching the state history",severity:"error"},u instanceof Error?u.message:"Unable to fetch alert state history");const xe=N.length<v.length,Ne=B>0?`No matches were found for the given filters among the ${B} instances`:"No state transitions have occurred in the last 30 days";return e.createElement("div",{className:n.fullSize},e.createElement("form",{onSubmit:h(b=>r(b.query))},e.createElement(U,{...m("query"),showClearFilterSuffix:!!s,onClearFilterClick:G}),e.createElement("input",{type:"submit",hidden:!0})),!(0,y.isEmpty)(R)&&e.createElement("div",{className:n.commonLabels},e.createElement(p.B,{gap:1,alignItems:"center"},e.createElement("strong",null,"Common labels"),e.createElement(D.m,{content:"Common labels are the ones attached to all of the alert instances"},e.createElement(S.I,{name:"info-circle"})),e.createElement(ee.m,{labels:(0,y.fromPairs)(R),size:"sm"}))),(0,y.isEmpty)(N)?e.createElement(e.Fragment,null,e.createElement("div",{className:n.emptyState},Ne,B>0&&e.createElement(V.$n,{variant:"secondary",type:"button",onClick:G},"Clear filters"))):e.createElement(e.Fragment,null,e.createElement("div",{className:n.graphWrapper},e.createElement(J,{frames:N,timeRange:Ie})),xe&&e.createElement("div",{className:n.moreInstancesWarning},e.createElement(p.B,{direction:"row",alignItems:"center",gap:1},e.createElement(S.I,{name:"exclamation-triangle",size:"sm"}),e.createElement("small",null,`Only showing ${N.length} out of ${v.length} instances. Click on the labels to narrow down the results`))),e.createElement(z,{records:$,commonLabels:R,onRecordsRendered:b=>c.current=b,onLabelClick:Te})))};function Le(t){return(0,e.useMemo)(()=>{const n=(0,y.take)(t,ve),s=(0,y.sortBy)((0,y.uniq)(n.flatMap(h=>h.fields[0].values))),r=Math.min(...s),c=Math.max(...s),i=(0,E.KQ)(r),o=(0,E.KQ)(c);return{frameSubset:n,frameSubsetTimestamps:s,frameTimeRange:{from:i,to:o,raw:{from:i,to:o}}}},[t])}const U=e.forwardRef(({showClearFilterSuffix:t,onClearFilterClick:n,...s},r)=>e.createElement(Z.D,{label:e.createElement(w.J,{htmlFor:"instancesSearchInput"},e.createElement(p.B,{gap:.5},e.createElement("span",null,"Filter instances"),e.createElement(te.j,{content:e.createElement(e.Fragment,null,"Use label matcher expression (like ",e.createElement("code",null,"{foo=bar}"),") or click on an instance label to filter instances")},e.createElement(S.I,{name:"info-circle",size:"sm"}))))},e.createElement(k.p,{id:"instancesSearchInput",prefix:e.createElement(S.I,{name:"search"}),suffix:t&&e.createElement(V.$n,{fill:"text",icon:"times",size:"sm",onClick:n},"Clear"),placeholder:"Filter instances",ref:r,...s})));U.displayName="SearchFieldInput";function Re(){const t=(0,E.KQ)().subtract(30,"days"),n=(0,E.KQ)();return{from:t,to:n,raw:{from:t,to:n}}}const Q=t=>({fullSize:(0,d.css)({minWidth:"100%",height:"100%",display:"flex",flexDirection:"column"}),graphWrapper:(0,d.css)({padding:`${t.spacing()} 0`}),emptyState:(0,d.css)({color:t.colors.text.secondary,display:"flex",flexDirection:"column",gap:t.spacing(2),alignItems:"center",margin:"auto auto"}),moreInstancesWarning:(0,d.css)({color:t.colors.warning.text,padding:t.spacing()}),commonLabels:(0,d.css)({display:"grid",gridTemplateColumns:"max-content auto"}),highlightedLogRecord:(0,d.css)({background:`${t.colors.primary.transparent} !important`,outline:`1px solid ${t.colors.primary.shade} !important`})}),be=Se},70026:(Y,I,a)=>{a.d(I,{$:()=>e,Q:()=>C});var d=a(2543),y=a.n(d);function e(E,f){return E.filter(T=>!f.find(p=>JSON.stringify(p)===JSON.stringify(T)))}function C(E){const f=E.flatMap(p=>p);return(0,d.uniqBy)(f.filter(p=>f.filter(S=>(0,d.isEqual)(p,S)).length===Object.keys(E).length),p=>JSON.stringify(p))}}}]);

//# sourceMappingURL=1121.3f15f55f2dc33e3317ba.js.map