"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[9438],{53191:(se,$,r)=>{r.r($),r.d($,{default:()=>Xe});var e=r(96540),h=r(55852),p=r(67061),M=r(94753),w=r(37959),Q=r(96636),le=r(87978),ce=r(63021),K=r(40675),E=r(57220),G=r(32196),ue=r(49785),ge=r(70713),X=r(40845),T=r(42418),de=r(32372),k=r(96374),me=r(25027),fe=r(51488),q=r(61410),_=r(26058);function ve({alertmanagerName:t,onDismiss:n,onSave:a,onReset:i}){const{loading:s,error:l}=(0,q.$)(I=>I.deleteAMConfig),{loading:d,error:o}=(0,q.$)(I=>I.saveAMConfig),[u,g]=(0,e.useState)(!1),v=t?(0,E.AL)(t):!1,S=t===E.hY,C=(0,X.of)(Ee),{currentData:y,error:N,isSuccess:R,isLoading:m}=(0,fe.f)(t),c={configJSON:y?JSON.stringify(y,null,2):""},{register:f,setValue:D,setError:L,handleSubmit:j,formState:{errors:U}}=(0,ue.mN)({defaultValues:c});(0,e.useEffect)(()=>{y&&D("configJSON",JSON.stringify(y,null,2))},[y,D]),(0,e.useEffect)(()=>{o&&L("configJSON",{type:"deps",message:o.message})},[o,L]),(0,e.useEffect)(()=>{l&&L("configJSON",{type:"deps",message:l.message})},[l,L]),f("configJSON",{required:{value:!0,message:"Configuration cannot be empty"},validate:I=>{try{return JSON.parse(I),!0}catch(Y){return Y instanceof Error?Y.message:"JSON is invalid"}}});const H=j(I=>{a(t,c.configJSON,I.configJSON)},me.KF),W=m||s||d;if(N)return e.createElement(T.F,{severity:"error",title:"Failed to load Alertmanager configuration"},N.message??"An unknown error occurred.");if(s)return e.createElement(T.F,{severity:"info",title:"Resetting Alertmanager configuration"},"Resetting configuration, this might take a while.");const qe=S?"Are you sure you want to reset configuration for the Grafana Alertmanager? Contact points and notification policies will be reset to their defaults.":`Are you sure you want to reset configuration for "${t}"? Contact points and notification policies will be reset to their defaults.`;return e.createElement("div",{className:C.container},U.configJSON&&e.createElement(T.F,{severity:"error",title:"Oops, something went wrong"},U.configJSON.message||"An unknown error occurred."),R&&e.createElement("div",{className:C.content},e.createElement(ge.Ay,null,({height:I,width:Y})=>e.createElement(de.B,{language:"json",width:Y,height:I,showLineNumbers:!0,monacoOptions:{scrollBeyondLastLine:!1},value:c.configJSON,showMiniMap:!1,onSave:Z=>D("configJSON",Z),onBlur:Z=>D("configJSON",Z),readOnly:W}))),e.createElement(p.B,{justifyContent:"flex-end"},!v&&e.createElement(h.$n,{variant:"destructive",onClick:()=>g(!0),disabled:W},"Reset"),e.createElement(_.h,null),e.createElement(h.$n,{variant:"secondary",onClick:()=>n(),disabled:W},"Cancel"),!v&&e.createElement(h.$n,{variant:"primary",onClick:H,disabled:W},"Save")),e.createElement(k.u,{isOpen:u,title:"Reset Alertmanager configuration",body:qe,confirmText:"Yes, reset configuration",onConfirm:()=>{i(t),g(!1)},onDismiss:()=>{g(!1)}}))}const Ee=t=>({container:(0,G.css)({display:"flex",flexDirection:"column",height:"100%",gap:t.spacing(2)}),content:(0,G.css)({flex:"1 1 100%"})});var O=r(2543),Ae=r(26272),Se=r(3591),he=r(32264),x=r(60021),z=r(99140),J=r(82843),pe=r(49962);const V=pe.H.injectEndpoints({endpoints:t=>({getAllDataSourceSettings:t.query({query:()=>({url:"api/datasources"}),providesTags:n=>n?n.map(({uid:a})=>({type:"DataSourceSettings",id:a})):["DataSourceSettings"]}),getDataSourceSettingsForUID:t.query({query:n=>({url:`api/datasources/uid/${n}`}),providesTags:(n,a,i)=>[{type:"DataSourceSettings",id:i}]}),updateDataSourceSettingsForUID:t.mutation({query:({uid:n,settings:a})=>({url:`api/datasources/uid/${n}`,method:"PUT",data:a,showSuccessAlert:!1}),invalidatesTags:(n,a,i)=>[{type:"DataSourceSettings",id:i.uid}]})})});function Ce({refetchOnMountOrArgChange:t=!1}={}){const{alertmanagerDataSources:n}=V.endpoints.getAllDataSourceSettings.useQuery(void 0,{refetchOnReconnect:!0,refetchOnMountOrArgChange:t,selectFromResult:i=>{const s=i.currentData?.filter(E.bD)??[];return{...i,alertmanagerDataSources:s}}}),{currentData:a}=J.m.endpoints.getExternalAlertmanagers.useQuery(void 0,{refetchOnReconnect:!0,refetchOnMountOrArgChange:t});return n?n.map(i=>{const s=a?ye(a,i):"unknown";return{dataSourceSettings:i,status:s}}):[]}function ye(t,n){if(!n.jsonData.handleGrafanaManagedAlerts)return"uninterested";const i=t?.activeAlertManagers.some(o=>ee(n.url,o.url))??[],s=t?.droppedAlertManagers.some(o=>ee(n.url,o.url))??[];return!i&&!s?"pending":i&&s?"inconclusive":i?"active":s?"dropped":"unknown"}const De="/alertmanager/api/v2/alerts",Ie="/api/v2/alerts";function ee(t,n){const a=Me(t),i=n===`${a}${Ie}`,s=n===`${a}${De}`;return i||s}function Me(t){return(new RegExp("^[^:]*://").test(t)?t:`http://${t}`).replace(/\/+$/,"")}var te=r(23770);const ne=t=>{if(!t)return!0;switch(t.alertmanagersChoice){case x.nA.Internal:case x.nA.All:return!0;case x.nA.External:default:return!1}};var xe=r(1932);const Le=()=>{const[t,n]=V.endpoints.getDataSourceSettingsForUID.useLazyQuery(),[a,i]=V.endpoints.updateDataSourceSettingsForUID.useMutation(),s=async(u,g)=>{const A=await t(u).unwrap();if(!(0,E.bD)(A))throw new Error(`Data source with UID ${u} is not an Alertmanager data source`);const v=(0,xe.jM)(A,S=>{S.jsonData.handleGrafanaManagedAlerts=g});a({uid:u,settings:v})},l=u=>s(u,!0),d=u=>s(u,!1),o={isLoading:n.isLoading||i.isLoading,isError:n.isError||i.isError,error:n.error||i.error,data:i.data};return[l,d,o]},Oe=(0,Se.J7)(),ae=e.createContext(void 0),re=t=>t===E.hY,Ne=t=>{let n=[];const a=he.$.featureToggles.alertingDisableSendAlertsExternal===!0,{currentData:i,isLoading:s}=J.m.endpoints.getGrafanaAlertingConfiguration.useQuery(),[l,d]=J.m.endpoints.updateGrafanaAlertingConfiguration.useMutation(),[o,u,g]=Le(),A=Ce({refetchOnMountOrArgChange:!0});ne(i)&&n.push(E.hY),A.filter(m=>(0,E.iV)(m.dataSourceSettings)).forEach(m=>{n.push(m.dataSourceSettings.uid)});const S=m=>{const c=(0,O.union)([m],n),f=oe(c);f!==null&&(f!==i?.alertmanagersChoice&&l({alertmanagersChoice:f}),re(m)||o(m))},C=m=>{const c=(0,O.without)(n,m),f=oe(c);f!==null&&(f!==i?.alertmanagersChoice&&l({alertmanagersChoice:f}),re(m)||u(m))},y=(m,c,f)=>{(0,z.JD)((0,te.RW)({newConfig:JSON.parse(f),oldConfig:JSON.parse(c),alertManagerSourceName:m,successMessage:"Alertmanager configuration updated."}))},N=m=>{(0,z.JD)((0,te.nO)(m))},R={configuration:i,forwardingDisabled:a,externalAlertmanagerDataSourcesWithStatus:A,enableAlertmanager:S,disableAlertmanager:C,isLoading:s,isUpdating:d.isLoading||g.isLoading,updateAlertmanagerSettings:y,resetAlertmanagerSettings:N};return e.createElement(ae.Provider,{value:R},t.children)};function oe(t){const n=t.some(i=>i===E.hY),a=t.some(i=>i!==E.hY);return n&&a?x.nA.All:!n&&a?x.nA.External:n&&!a?x.nA.Internal:(Oe.publish({type:Ae.r1.alertError.name,payload:["You need to have at least one Alertmanager to receive alerts."]}),null)}function F(){const t=e.useContext(ae);if(t===void 0)throw new Error("useSettings must be used within a SettingsContext");const n=(0,O.debounce)(()=>{(0,z.JD)(V.util.invalidateTags(["AlertmanagerConnectionStatus"]))},3e3),a=(0,e.useRef)(n);return t.externalAlertmanagerDataSourcesWithStatus.some(({status:s})=>s==="pending")&&a.current(),(0,e.useEffect)(()=>{n.cancel()},[n]),t}var Re=r(95093),be=r.n(Re),B=r(39938),Te=r(48840),Je=r(22764),Be=r(56596),$e=r(56361);const we=30,Ge=({alertmanagerName:t})=>{const[n,a]=(0,e.useState)(void 0),[i,s]=(0,e.useState)(!1),[l,d]=(0,e.useState)(void 0),{currentData:o=[],isLoading:u,error:g}=J.m.endpoints.getAlertmanagerConfigurationHistory.useQuery(void 0),[A,v]=J.m.endpoints.resetAlertmanagerConfigurationToOldVersion.useMutation(),S=()=>{s(!0)},C=()=>{s(!1)},y=c=>{d(void 0),a(void 0),A({id:c})};if(g)return e.createElement(T.F,{title:"Failed to load configuration history"},(0,$e.JZ)(g));if(u)return"Loading...";if(!o.length)return"No previous configurations";const R=o.map((c,f)=>{const D=o[0],L=o[f];return{...c,diff:L?Ue(c,D):{added:0,removed:0}}}).map(c=>({id:String(c.id??0),lastAppliedAt:c.last_applied??"unknown",diff:c.diff})),m=[{id:"lastAppliedAt",header:"Last applied",cell:Fe},{id:"diff",disableGrow:!0,cell:({row:c,value:f})=>c.index===0?null:e.createElement(p.B,{alignItems:"baseline",gap:.5},e.createElement(M.E,{color:"success",variant:"bodySmall"},"+",f.added),e.createElement(M.E,{color:"error",variant:"bodySmall"},"-",f.removed))},{id:"actions",disableGrow:!0,cell:({row:c})=>{const f=c.index===0,D=Number(c.id);return e.createElement(p.B,{direction:"row",alignItems:"center",justifyContent:"flex-end"},f?e.createElement(B.E,{text:"Latest",color:"blue"}):e.createElement(e.Fragment,null,e.createElement(h.$n,{variant:"secondary",size:"sm",icon:"code-branch",fill:"outline",onClick:()=>{const L=o[0],j=o[c.index],U=P(L),H=P(j);a(D),d([JSON.stringify(U,null,2),JSON.stringify(H,null,2)])}},"Compare"),e.createElement(h.$n,{variant:"secondary",size:"sm",icon:"history",onClick:()=>{a(D),S()},disabled:v.isLoading},"Restore")))}}];return v.isLoading?e.createElement(T.F,{severity:"info",title:"Restoring Alertmanager configuration"},"This might take a while..."):e.createElement(e.Fragment,null,l?e.createElement(Ve,{left:l[0],right:l[1],disabled:v.isLoading,onCancel:()=>{a(void 0),d(void 0),C()},onConfirm:()=>{S()}}):e.createElement(Te.j,{pageSize:we,columns:m,data:R,getRowId:c=>c.id}),e.createElement(k.u,{isOpen:i,title:"Restore Version",body:"Are you sure you want to restore the configuration to this version? All unsaved changes will be lost.",confirmText:"Yes, restore configuration",onConfirm:()=>{n&&y(n),C()},onDismiss:()=>C()}))};function Ve({left:t,right:n,disabled:a=!1,onCancel:i,onConfirm:s}){const l=(0,X.of)(Pe);return e.createElement("div",{className:l.drawerWrapper},e.createElement("div",{className:l.diffWrapper},e.createElement(Je.M,{newValue:t,oldValue:n,hideLineNumbers:!0})),e.createElement(p.B,{direction:"row",alignItems:"center"},e.createElement(_.h,null),e.createElement(h.$n,{variant:"secondary",onClick:i,disabled:a},"Return"),e.createElement(h.$n,{icon:"history",variant:"primary",onClick:s,disabled:a},"Restore")))}const Fe=({value:t})=>{const n=be()(t);return e.createElement(p.B,{direction:"row",alignItems:"center"},n.toLocaleString(),e.createElement(M.E,{variant:"bodySmall",color:"secondary"},n.fromNow()))},Pe=t=>({drawerWrapper:(0,G.css)({maxHeight:"100%",display:"flex",flexDirection:"column",gap:t.spacing(1)}),diffWrapper:(0,G.css)({overflowY:"auto"})});function P(t){return(0,O.omit)(t,["id","last_applied"])}function Ue(t,n){const a=P(t),i=P(n),s=(0,Be.G4)(a,i),l=(0,O.chain)(s).values().flatMap().filter(o=>o.op==="add"||o.op==="replace"||o.op==="move").sumBy(o=>o.endLineNumber-o.startLineNumber+1).value(),d=(0,O.chain)(s).values().flatMap().filter(o=>o.op==="remove"||o.op==="replace").sumBy(o=>o.endLineNumber-o.startLineNumber+1).value();return{added:l,removed:d}}function We(){const[t,n]=(0,e.useState)("configuration"),[a,i]=(0,e.useState)(),[s,l]=(0,e.useState)(!1),{updateAlertmanagerSettings:d,resetAlertmanagerSettings:o}=F(),u=v=>{i(v),l(!0)},g=(0,e.useCallback)(()=>{n("configuration"),l(!1)},[]);return[(0,e.useMemo)(()=>{if(!s)return null;const v=a===E.hY,S=v?"Internal Grafana Alertmanager":a;return e.createElement(le._,{onClose:g,title:S,subtitle:"Edit the Alertmanager configuration",tabs:e.createElement(ce.U,null,e.createElement(K.o,{label:"JSON Model",key:"configuration",icon:"arrow",active:t==="configuration",onChangeTab:()=>n("configuration")}),e.createElement(K.o,{label:"Versions",key:"versions",icon:"history",active:t==="versions",onChangeTab:()=>n("versions"),hidden:!v}))},t==="configuration"&&a&&e.createElement(ve,{alertmanagerName:a,onDismiss:g,onSave:d,onReset:o}),t==="versions"&&a&&e.createElement(Ge,{alertmanagerName:a}))},[s,a,g,t,d,o]),u,g]}var Ye=r(83883),ze=r(3704),b=r(10860),je=r(72109),He=r(48205);function ie({name:t,href:n,url:a,logo:i="public/app/plugins/datasource/alertmanager/img/logo.svg",provisioned:s=!1,readOnly:l=s,showStatus:d=!0,implementation:o,receiving:u=!1,status:g="unknown",onEditConfiguration:A,onEnable:v,onDisable:S}){const C=!s&&!!v&&!!S;return e.createElement(b.Z,{"data-testid":`alertmanager-card-${t}`},e.createElement(b.Z.Heading,null,e.createElement(p.B,{alignItems:"center",gap:1},n?e.createElement(Q.d,{title:"Alerting settings",component:e.createElement(je.Y,{href:n,inline:!1},t)}):t,s&&e.createElement(He.rS,null))),e.createElement(b.Z.Figure,null,e.createElement("img",{alt:`logo for ${t}`,src:i})),e.createElement(b.Z.Meta,null,e.createElement(p.B,{direction:"column",gap:1,alignItems:"flex-start"},e.createElement(b.Z.Meta,null,o&&(0,O.capitalize)(o),a&&a),d?e.createElement(e.Fragment,null,u?e.createElement(e.Fragment,null,g==="pending"&&e.createElement(B.E,{text:"Activation in progress",color:"orange"}),g==="active"&&e.createElement(B.E,{text:"Receiving Grafana-managed alerts",color:"green"}),g==="dropped"&&e.createElement(B.E,{text:"Failed to adopt Alertmanager",color:"red"}),g==="inconclusive"&&e.createElement(B.E,{text:"Inconclusive",color:"orange"})):e.createElement(M.E,{variant:"bodySmall"},"Not receiving Grafana managed alerts")):null)),e.createElement(b.Z.Tags,null,e.createElement(p.B,{direction:"row",gap:1},e.createElement(h.$n,{onClick:A,icon:l?"eye":"edit",variant:"secondary",fill:"outline"},l?"View configuration":"Edit configuration"),C?e.createElement(e.Fragment,null,u?e.createElement(h.$n,{icon:"times",variant:"destructive",fill:"outline",onClick:S},"Disable"):e.createElement(h.$n,{icon:"check",variant:"secondary",fill:"outline",onClick:v},"Enable")):null)))}const Ze=({onEditConfiguration:t})=>{const{externalAlertmanagerDataSourcesWithStatus:n,configuration:a,enableAlertmanager:i,disableAlertmanager:s,forwardingDisabled:l}=F(),d=o=>{const u=[x.nA.All,x.nA.External].some(A=>a?.alertmanagersChoice===A),g=(0,E.iV)(o.dataSourceSettings);return u&&g};return e.createElement(p.B,{direction:"column",gap:0},n.map(o=>{const{uid:u,name:g,jsonData:A,url:v}=o.dataSourceSettings,{status:S}=o,C=d(o),y=(0,E.yc)(o.dataSourceSettings),N=(0,E.AL)(o.dataSourceSettings.name),R=(0,ze.c)(Ye.I.Edit.replace(/:uid/gi,u)),m=()=>t(g),c=l?void 0:()=>i(u),f=l?void 0:()=>s(u);return e.createElement(ie,{key:u,name:g,href:R,url:v,provisioned:y,readOnly:N,showStatus:!l,implementation:A.implementation??"Prometheus",receiving:C,status:S,onEditConfiguration:m,onDisable:f,onEnable:c})}))},Qe="Grafana built-in";function Ke({onEditConfiguration:t}){const{configuration:n,enableAlertmanager:a,disableAlertmanager:i,forwardingDisabled:s}=F(),l=ne(n),d=l?"active":"uninterested",o=()=>t(E.hY),u=s?void 0:()=>a(E.hY),g=s?void 0:()=>i(E.hY);return e.createElement(ie,{name:Qe,logo:"public/img/grafana_icon.svg",status:d,receiving:l,onEditConfiguration:o,onEnable:u,onDisable:g})}function Xe(){return e.createElement(Ne,null,e.createElement(ke,null))}function ke(){const[t,n]=We(),{isLoading:a}=F();return e.createElement(w.d,{navId:"alerting-admin",isLoading:a,actions:[e.createElement(Q.d,{key:"add-alertmanager",title:"Alerting settings",component:e.createElement(h.z9,{href:"/connections/datasources/alertmanager",icon:"plus",variant:"primary"},"Add new Alertmanager")})]},e.createElement(p.B,{direction:"column",gap:2},e.createElement(M.E,{variant:"h5"},"Built-in Alertmanager"),e.createElement(Ke,{onEditConfiguration:n}),e.createElement(M.E,{variant:"h5"},"Other Alertmanagers"),e.createElement(Ze,{onEditConfiguration:n})),t)}},51488:(se,$,r)=>{r.d($,{f:()=>h});var e=r(82843);function h(p,M){const w=e.m.endpoints.getAlertmanagerConfiguration.useQuery(p??"",{refetchOnMountOrArgChange:!0,...M,skip:!p});return{...w,error:w.error}}}}]);

//# sourceMappingURL=AlertingSettings.b03308d43adac605e991.js.map